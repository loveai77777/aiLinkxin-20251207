# GitHub Actions è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµ
# éƒ¨ç½²åˆ°è‡ªå·±çš„æœåŠ¡å™¨
# 
# ä½¿ç”¨å‰éœ€è¦é…ç½® GitHub Secrets:
# - SERVER_HOST: æœåŠ¡å™¨ IP åœ°å€æˆ–åŸŸå
# - SERVER_USER: SSH ç”¨æˆ·åï¼ˆå¦‚ rootï¼‰
# - SERVER_SSH_KEY: SSH ç§é’¥ï¼ˆå®Œæ•´çš„ç§é’¥å†…å®¹ï¼‰
#
# ä½¿ç”¨æ–¹æ³•:
# 1. åœ¨æœåŠ¡å™¨ä¸Šé…ç½® SSH å¯†é’¥è®¤è¯
# 2. åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ ä¸Šè¿° Secrets
# 3. å–æ¶ˆä¸‹é¢éƒ¨ç½²æ­¥éª¤çš„æ³¨é‡Š
# 4. æ¨é€ä»£ç åˆ° main åˆ†æ”¯å³å¯è‡ªåŠ¨éƒ¨ç½²

name: Deploy to Production Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    # éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆä½¿ç”¨ git pull æ–¹å¼ï¼Œæ›´ç®€å•ï¼‰
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          cd /var/www/ailinkxin
          
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
          git fetch origin
          git pull origin main
          
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm install
          
          echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
          npm run build
          
          echo "ğŸ”„ é‡å¯åº”ç”¨..."
          pm2 restart ailinkxin || pm2 start ecosystem.config.js
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          
          # æ˜¾ç¤ºçŠ¶æ€
          pm2 status

