# GitHub Actions 自动部署工作流
# 如果您使用自己的服务器，可以使用此工作流
# 需要配置 GitHub Secrets: SERVER_HOST, SERVER_USER, SERVER_SSH_KEY

name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build
      run: npm run build
      
    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp -r .next deploy/
        cp -r public deploy/
        cp package.json deploy/
        cp package-lock.json deploy/
        cp next.config.js deploy/
        cp tsconfig.json deploy/
        cp -r app deploy/
        cp -r components deploy/
        cp -r lib deploy/
        cp -r content deploy/
        tar -czf deploy.tar.gz -C deploy .
        
    # 如果您使用自己的服务器，取消下面的注释并配置 Secrets
    # - name: Deploy to server
    #   uses: appleboy/scp-action@master
    #   with:
    #     host: ${{ secrets.SERVER_HOST }}
    #     username: ${{ secrets.SERVER_USER }}
    #     key: ${{ secrets.SERVER_SSH_KEY }}
    #     source: "deploy.tar.gz"
    #     target: "/var/www/ailinkxin"
    #     
    # - name: Extract and restart on server
    #   uses: appleboy/ssh-action@master
    #   with:
    #     host: ${{ secrets.SERVER_HOST }}
    #     username: ${{ secrets.SERVER_USER }}
    #     key: ${{ secrets.SERVER_SSH_KEY }}
    #     script: |
    #       cd /var/www/ailinkxin
    #       tar -xzf deploy.tar.gz
    #       npm install --production
    #       pm2 restart ailinkxin || pm2 start npm --name "ailinkxin" -- start

